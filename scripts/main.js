(()=>{"use strict";const e={baseUrl:"https://nomoreparties.co/v1/wff-cohort-36",headers:{authorization:"7eda4b69-1241-4134-ae0f-5b43345c19b6","Content-Type":"application/json"}},t=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),r=document.querySelector("#card-template").content,n=(r,n,o)=>{(function(r,n){return fetch(`${e.baseUrl}/cards/likes/${r}`,{headers:e.headers,method:n?"DELETE":"PUT"}).then(t)})(r,n.classList.contains("card__like-button_is-active")).then((e=>{n.classList.toggle("card__like-button_is-active"),o.textContent=e.likes.length})).catch((e=>console.log(e)))},o=(e,{handleDeleteCard:t,handleLikeCard:n,handlePreviewCard:o},a)=>{const s=r.querySelector(".card").cloneNode(!0),l=s.querySelector(".card__delete-button");e.owner._id===a&&t?l.addEventListener("click",(()=>{t(e._id,s)})):l.remove();const c=s.querySelector(".card__image");c.alt=e.name,c.src=e.link,o&&c.addEventListener("click",o.bind(null,e));const i=s.querySelector(".card__like-button");e.likes.some((e=>e._id===a))?i.classList.add("card__like-button_is-active"):i.classList.remove("card__like-button_is-active");const d=s.querySelector(".card__like-counter");return d.textContent=e.likes.length,n&&i.addEventListener("click",(()=>{n(e._id,i,d)})),s.querySelector(".card__title").textContent=e.name,s},a=e=>{if("Escape"===e.key){const e=document.querySelector(".popup_is-opened");l(e)}},s=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keydown",a)},l=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",a)},c=e=>{e.querySelector(".popup__close").addEventListener("click",l.bind(null,e)),e.addEventListener("mousedown",(t=>{t.target.classList.contains("popup")&&l(e)}))},i=(e,t)=>{const r=e.nextElementSibling;r.textContent="",r.classList.remove(t.inputErrorMessageClass),e.setCustomValidity(""),e.classList.remove(t.inputErrorClass)},d=(e,t,r)=>{(e=>e.some((e=>!e.validity.valid)))(e)?(t.classList.add(r.inactiveButtonClass),t.setAttribute("disabled","true")):(t.classList.remove(r.inactiveButtonClass),t.removeAttribute("disabled"))},u=(e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);r.forEach((e=>{i(e,t)})),d(r,n,t)};let p;const m={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",inputErrorMessageClass:"popup__input-error-message_visible"};let _;const h=document.querySelector(".places__list"),v=document.forms,y=v["delete-card"],b=v["edit-avatar"],S=v["edit-profile"],C=v["new-place"],f=document.querySelector(".profile"),E=f.querySelector(".profile__add-button"),L=f.querySelector(".profile__description"),q=f.querySelector(".profile__edit-button"),k=f.querySelector(".profile__image"),g=f.querySelector(".profile__title"),x=document.querySelector(".popup_type_delete-card"),w=document.querySelector(".popup_type_edit-avatar"),A=document.querySelector(".popup_type_edit-profile"),B=document.querySelector(".popup_type_image"),$=document.querySelector(".popup_type_new-card"),D=B.querySelector(".popup__caption"),P=B.querySelector(".popup__image");E.addEventListener("click",(()=>{C.reset(),u(C,m),s($)})),q.addEventListener("click",(()=>{S.elements.name.value=g.textContent,S.elements.description.value=L.textContent,u(S,m),s(A)})),k.addEventListener("click",(()=>{b.reset(),u(b,m),s(w)})),c(x),c(w),c(A),c(B),c($),(e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>((e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);d(r,n,t),r.forEach((e=>{e.addEventListener("input",(()=>{((e,t)=>{e.validity.patternMismatch?e.setCustomValidity(e.dataset.errorMessage):e.setCustomValidity(""),e.validity.valid?i(e,t):((e,t,r)=>{const n=e.nextElementSibling;n.textContent=t,n.classList.add(r.inputErrorMessageClass),e.classList.add(r.inputErrorClass)})(e,e.validationMessage,t)})(e,t),d(r,n,t)}))}))})(t,e)))})(m);const U=(e,t)=>{p={cardId:e,cardElement:t},s(x)},T=({name:e,link:t})=>{D.textContent=e,P.alt=e,P.src=t,s(B)};y.addEventListener("submit",(r=>{r.preventDefault();const n=y.querySelector(m.submitButtonSelector);var o;n.textContent="Удаление...",p?(o=p.cardId,fetch(`${e.baseUrl}/cards/${o}`,{headers:e.headers,method:"DELETE"}).then(t)).then((()=>{p.cardElement.remove(),p=null,l(x)})).catch((e=>console.error(e))).finally((()=>{n.textContent="Да"})):l(x)})),b.addEventListener("submit",(r=>{r.preventDefault();const n=b.querySelector(m.submitButtonSelector);var o;n.textContent="Сохранение...",(o=b.elements.avatar.value,fetch(`${e.baseUrl}/users/me/avatar`,{headers:e.headers,method:"PATCH",body:JSON.stringify({avatar:o})}).then(t)).then((e=>{k.src=e.avatar,l(w)})).catch((e=>console.error(e))).finally((()=>{n.textContent="Сохранить"}))})),S.addEventListener("submit",(r=>{r.preventDefault();const n=S.querySelector(m.submitButtonSelector);n.textContent="Сохранение...",(({name:r,about:n})=>fetch(`${e.baseUrl}/users/me`,{headers:e.headers,method:"PATCH",body:JSON.stringify({name:r,about:n})}).then(t))({name:S.elements.name.value,about:S.elements.description.value}).then((e=>{g.textContent=e.name,L.textContent=e.about,k.alt=e.name,l(A)})).catch((e=>console.log(e))).finally((()=>{n.textContent="Сохранить"}))})),C.addEventListener("submit",(r=>{r.preventDefault();const a=C.querySelector(m.submitButtonSelector);a.textContent="Создание...",(({name:r,link:n})=>fetch(`${e.baseUrl}/cards`,{headers:e.headers,method:"POST",body:JSON.stringify({name:r,link:n})}).then(t))({name:C.elements["place-name"].value,link:C.elements.link.value}).then((e=>{const t=o(e,{handleDeleteCard:U,handleLikeCard:n,handlePreviewCard:T},_);h.prepend(t),l($)})).catch((e=>console.log(e))).finally((()=>{a.textContent="Создать"}))})),Promise.all([fetch(`${e.baseUrl}/cards`,{headers:e.headers}).then(t),fetch(`${e.baseUrl}/users/me`,{headers:e.headers}).then(t)]).then((([e,t])=>{_=t._id,e.forEach((e=>{const t=o(e,{handleDeleteCard:U,handleLikeCard:n,handlePreviewCard:T},_);h.append(t)})),L.textContent=t.about,k.alt=t.name,k.src=t.avatar,g.textContent=t.name})).catch((e=>console.log(e)))})();